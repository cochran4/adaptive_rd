<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Amy Cochran">

<title>Adaptive RD demonstration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="adaptive_rd_demo_files/libs/clipboard/clipboard.min.js"></script>
<script src="adaptive_rd_demo_files/libs/quarto-html/quarto.js"></script>
<script src="adaptive_rd_demo_files/libs/quarto-html/popper.min.js"></script>
<script src="adaptive_rd_demo_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="adaptive_rd_demo_files/libs/quarto-html/anchor.min.js"></script>
<link href="adaptive_rd_demo_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="adaptive_rd_demo_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="adaptive_rd_demo_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="adaptive_rd_demo_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="adaptive_rd_demo_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="adaptive_rd_demo.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#load-packages" id="toc-load-packages" class="nav-link" data-scroll-target="#load-packages">Load packages</a></li>
  <li><a href="#build-template-dataset" id="toc-build-template-dataset" class="nav-link" data-scroll-target="#build-template-dataset">Build template dataset</a></li>
  <li><a href="#simulation" id="toc-simulation" class="nav-link" data-scroll-target="#simulation">Simulation</a>
  <ul class="collapse">
  <li><a href="#increasing-uptake-of-a-resource-limited-prevention-program" id="toc-increasing-uptake-of-a-resource-limited-prevention-program" class="nav-link" data-scroll-target="#increasing-uptake-of-a-resource-limited-prevention-program">Increasing uptake of a resource-limited prevention program</a></li>
  <li><a href="#prioritizing-patients-for-a-new-lipid-lowering-medication" id="toc-prioritizing-patients-for-a-new-lipid-lowering-medication" class="nav-link" data-scroll-target="#prioritizing-patients-for-a-new-lipid-lowering-medication">Prioritizing patients for a new lipid-lowering medication</a></li>
  <li><a href="#balancing-benefit-and-burden-through-number-needed-to-treat" id="toc-balancing-benefit-and-burden-through-number-needed-to-treat" class="nav-link" data-scroll-target="#balancing-benefit-and-burden-through-number-needed-to-treat">Balancing benefit and burden through number needed to treat</a></li>
  <li><a href="#recalibrating-the-risk-model" id="toc-recalibrating-the-risk-model" class="nav-link" data-scroll-target="#recalibrating-the-risk-model">Recalibrating the risk model</a></li>
  <li><a href="#revising-model-to-remove-race-and-gender" id="toc-revising-model-to-remove-race-and-gender" class="nav-link" data-scroll-target="#revising-model-to-remove-race-and-gender">Revising model to remove race and gender</a></li>
  </ul></li>
  <li><a href="#save-panels" id="toc-save-panels" class="nav-link" data-scroll-target="#save-panels">Save panels</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Adaptive RD demonstration</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Amy Cochran </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This document demonstrates how to <strong>simulate an adaptive regression discontinuity (RD) design</strong> and use the resulting data to evaluate the performance of <strong>adaptive RD estimators</strong>.</p>
<p>In an adaptive RD design, treatment assignment depends on whether a patient’s predicted risk exceeds a decision threshold. Unlike a traditional RD, both the prediction model and the threshold can evolve over time. For example, the threshold may adapt to achieve a target treatment rate or a clinical performance metric, such as the number-needed-to-treat (NNT). The prediction model may also be recalibrated or revised using accumulated patient data.</p>
<p>To simulate such a design, we first define its core components — the study population, the prediction model, the adaptation rules for the threshold or model, and the outcome mechanism. The table below provides a concrete example using <strong>cardiovascular risk prediction in the general population</strong>.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Design Component</strong></th>
<th><strong>Cardiovascular Risk Example</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Inclusion criteria</strong></td>
<td>Adults aged 40–79 in the general population</td>
</tr>
<tr class="even">
<td><strong>Exclusion criteria</strong></td>
<td>History of cardiovascular disease or contraindication to preventive therapy</td>
</tr>
<tr class="odd">
<td><strong>Model</strong></td>
<td>Risk model predicting 10-year ASCVD risk (e.g., pooled cohort equations [PCE])</td>
</tr>
<tr class="even">
<td><strong>Intervention</strong></td>
<td>Referral to preventive care program (e.g., cardiovascular health clinic, medication review, and lifestyle counseling)</td>
</tr>
<tr class="odd">
<td><strong>Comparator</strong></td>
<td>Continue routine care without referral</td>
</tr>
<tr class="even">
<td><strong>Trigger event</strong></td>
<td>Annual primary care visit</td>
</tr>
<tr class="odd">
<td><strong>Allocation</strong></td>
<td>Automatic referral if predicted risk exceeds the current threshold</td>
</tr>
<tr class="even">
<td><strong>Threshold adaptation</strong></td>
<td>Threshold chosen to target specific referral rate or desired NNT</td>
</tr>
<tr class="odd">
<td><strong>Model adaptation</strong></td>
<td>Annual model recalibration or revision using most recent data</td>
</tr>
<tr class="even">
<td><strong>Follow-up period</strong></td>
<td>Six months after index visit</td>
</tr>
<tr class="odd">
<td><strong>Outcomes</strong></td>
<td>Change in systolic blood pressure, referral completion, or occurrence of cardiovascular event</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="load-packages" class="level2">
<h2 class="anchored" data-anchor-id="load-packages">Load packages</h2>
<p>We load the core functions and dependencies needed for data processing, risk prediction, and adaptive thresholding. All package imports are managed through a single script to keep the workflow reproducible and organized.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Core package imports along with core functionality</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"R/imports.R"</span>)           </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting seed for reproducibility</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="build-template-dataset" class="level2">
<h2 class="anchored" data-anchor-id="build-template-dataset">Build template dataset</h2>
<p>To generate realistic patient covariates, we sample with replacement from a cohort constructed using NHANES 2017–2018 data. The helper function <code>build_cohort()</code> reads and merges raw XPT files, filters adults aged 40–79, derives the variables required for PCE risk prediction (age, sex, race, blood pressure, cholesterol, smoking, diabetes, treatment status), imputes missing values, and standardizes variable names. Below, we (1) load the raw data, (2) build <code>cohort_df</code>, and (3) display a baseline summary before simulation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data_dir     <span class="ot">&lt;-</span> <span class="st">'data_raw'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>nh_list      <span class="ot">&lt;-</span> <span class="fu">read_nhanes_2017_2018</span>(data_dir)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>cohort_bundle <span class="ot">&lt;-</span> <span class="fu">build_cohort</span>(nh_list, <span class="at">impute =</span> <span class="cn">TRUE</span>, <span class="at">summarize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>cohort_df     <span class="ot">&lt;-</span> cohort_bundle<span class="sc">$</span>data</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">c</span>(<span class="st">"data_dir"</span>, <span class="st">"nh_list"</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(cohort_bundle<span class="sc">$</span>summary<span class="sc">$</span>continuous, <span class="at">caption =</span> <span class="st">"Continuous predictors."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Continuous predictors.</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: right;">N</th>
<th style="text-align: right;">Missing</th>
<th style="text-align: right;">Mean</th>
<th style="text-align: right;">SD</th>
<th style="text-align: right;">Min</th>
<th style="text-align: right;">Max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">5751</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">58.2</td>
<td style="text-align: right;">10.6</td>
<td style="text-align: right;">40.0</td>
<td style="text-align: right;">79.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">sbp</td>
<td style="text-align: right;">5751</td>
<td style="text-align: right;">868</td>
<td style="text-align: right;">128.5</td>
<td style="text-align: right;">19.4</td>
<td style="text-align: right;">76.3</td>
<td style="text-align: right;">218.7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hdl_c</td>
<td style="text-align: right;">5751</td>
<td style="text-align: right;">752</td>
<td style="text-align: right;">53.7</td>
<td style="text-align: right;">16.4</td>
<td style="text-align: right;">5.0</td>
<td style="text-align: right;">187.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">tot_chol</td>
<td style="text-align: right;">5751</td>
<td style="text-align: right;">752</td>
<td style="text-align: right;">190.4</td>
<td style="text-align: right;">42.1</td>
<td style="text-align: right;">71.0</td>
<td style="text-align: right;">446.0</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(cohort_bundle<span class="sc">$</span>summary<span class="sc">$</span>categorical, <span class="at">caption =</span> <span class="st">"Categorical predictors."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Categorical predictors.</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Level</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">Percent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">sex</td>
<td style="text-align: left;">Female</td>
<td style="text-align: right;">2911</td>
<td style="text-align: right;">50.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">sex</td>
<td style="text-align: left;">Male</td>
<td style="text-align: right;">2840</td>
<td style="text-align: right;">49.4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">race</td>
<td style="text-align: left;">Black</td>
<td style="text-align: right;">1633</td>
<td style="text-align: right;">28.4</td>
</tr>
<tr class="even">
<td style="text-align: left;">race</td>
<td style="text-align: left;">Other</td>
<td style="text-align: right;">2208</td>
<td style="text-align: right;">38.4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">race</td>
<td style="text-align: left;">White</td>
<td style="text-align: right;">1910</td>
<td style="text-align: right;">33.2</td>
</tr>
<tr class="even">
<td style="text-align: left;">smoker_current</td>
<td style="text-align: left;">0</td>
<td style="text-align: right;">1529</td>
<td style="text-align: right;">26.6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">smoker_current</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">1047</td>
<td style="text-align: right;">18.2</td>
</tr>
<tr class="even">
<td style="text-align: left;">smoker_current</td>
<td style="text-align: left;">Missing</td>
<td style="text-align: right;">3175</td>
<td style="text-align: right;">55.2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">diabetes</td>
<td style="text-align: left;">0</td>
<td style="text-align: right;">4348</td>
<td style="text-align: right;">75.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">diabetes</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">1193</td>
<td style="text-align: right;">20.7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">diabetes</td>
<td style="text-align: left;">Missing</td>
<td style="text-align: right;">210</td>
<td style="text-align: right;">3.7</td>
</tr>
<tr class="even">
<td style="text-align: left;">bp_treated</td>
<td style="text-align: left;">0</td>
<td style="text-align: right;">343</td>
<td style="text-align: right;">6.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bp_treated</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">2284</td>
<td style="text-align: right;">39.7</td>
</tr>
<tr class="even">
<td style="text-align: left;">bp_treated</td>
<td style="text-align: left;">Missing</td>
<td style="text-align: right;">3124</td>
<td style="text-align: right;">54.3</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="simulation" class="level2">
<h2 class="anchored" data-anchor-id="simulation">Simulation</h2>
<section id="increasing-uptake-of-a-resource-limited-prevention-program" class="level3">
<h3 class="anchored" data-anchor-id="increasing-uptake-of-a-resource-limited-prevention-program">Increasing uptake of a resource-limited prevention program</h3>
<p>In this first scenario, we simulate a cardiovascular prevention program that refers high-risk individuals to preventive care. Because program capacity is limited, only a fixed proportion of patients can be referred at any time. Rather than using a fixed clinical threshold (e.g., 10% ASCVD risk), we adopt a quantile-based rule: after an initial warm-up using the clinical cutoff, the threshold is updated so that approximately 30% of patients in each block are referred, based on observed risk scores. This approach emulates a health system striving to manage limited resources while targeting care to the highest-risk patients.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantile-based adaptation: set threshold so that a fraction is treated</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>threshold_method_quantile <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">type               =</span> <span class="st">"quantile"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">initial_threshold  =</span> <span class="fl">0.10</span>, <span class="co"># initial_threshold,</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">desired_treat_rate =</span> <span class="fl">0.30</span>  <span class="co"># 30% referral</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The risk prediction model is intentionally kept fixed in this scenario. This isolates the impact of threshold adaptation alone, allowing us to observe how referral decisions change under resource constraints without introducing changes in model calibration or discrimination.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># No adaptation (fixed model)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>model_method_none <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">type =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The outcome of interest in this scenario is whether a referred patient follows through and attends at least one visit in the prevention program. In practice, attendance reflects two forces: baseline risk and the incremental nudge from referral. We assume (i) patients with higher predicted risk are somewhat more likely to attend even without referral, but (ii) the <em>incremental</em> effect of referral exhibits diminishing returns—largest for mid‑risk patients and smaller for the very low‑ and very high‑risk. This captures the idea that low‑risk patients feel little urgency, while the sickest either face barriers or would attend regardless, so referral changes behavior least at the extremes.</p>
<p>The multiplicative term (({R}<em>{j,1}+1/2)(1-</em>{R}{j,1})) (scaled in code) peaks around the middle of the risk range and tapers to zero near 0 and 1, enforcing these diminishing returns. Formally, <span class="math display">\[
\mathbb{P}(Y_j = 1 \mid \bar{R}_{j,1}, A_j) = \alpha_0 + \alpha_1 \cdot \bar{R}_{j,1} + A_i \cdot \beta \cdot \left( \bar{R}_{j,1} +  1/2 \right)(1 - \bar{R}_{j,1}),
\]</span> where <span class="math inline">\(Y_j\)</span> is the outcome, <span class="math inline">\(A_j\)</span> is the intervention (referral) assignment, and <span class="math inline">\(\bar{R}_{j,1}\)</span> is the risk predicted from the original model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome: Prevention Program Attendance ---</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>attend_params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment_effect_intercept =</span> <span class="fl">0.25</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">reference_intercept        =</span> <span class="fl">0.00</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">reference_slope            =</span> <span class="fl">0.10</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Attendance probability ----</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>attendance_prob <span class="ot">&lt;-</span> <span class="cf">function</span>(cohort_df, idx, risk_baseline, treat, <span class="at">params =</span> attend_params) {</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Probability formula</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> params<span class="sc">$</span>reference_intercept <span class="sc">+</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    params<span class="sc">$</span>reference_slope <span class="sc">*</span> risk_baseline <span class="sc">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    treat <span class="sc">*</span> params<span class="sc">$</span>treatment_effect_intercept<span class="sc">*</span>(risk_baseline<span class="sc">+</span><span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>risk_baseline)<span class="sc">*</span><span class="dv">16</span><span class="sc">/</span><span class="dv">9</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>outcome_attend <span class="ot">&lt;-</span> <span class="cf">function</span>(cohort_df, idx, risk_baseline, treat, <span class="at">params =</span> attend_params) {</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">attendance_prob</span>(cohort_df, idx, risk_baseline, treat, params)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  stats<span class="sc">::</span><span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">length</span>(idx), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now bring the pieces together to simulate how the program operates over time. The <code>simulate_design()</code> function manages the full sequence of decision-making: it computes risk using <code>pce_predict()</code>, applies the adaptive threshold to determine referral, and then generates outcomes using <code>outcome_attend()</code>. Each block of patients is processed chronologically, allowing the threshold to update based on accumulated experience. Because the prediction model is held fixed, any change in referral behavior arises solely from the adaptive threshold.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- run the simulation ----</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>sim_out <span class="ot">&lt;-</span> <span class="fu">simulate_design</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">cohort_df              =</span> cohort_df,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk_fn                =</span> pce_predict,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">initial_block_size     =</span> <span class="dv">400</span>,   <span class="co"># warm-up</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">block_size             =</span> <span class="dv">100</span>,   <span class="co"># subsequent blocks</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_blocks               =</span> <span class="dv">26</span>,    <span class="co"># total post–warm-up blocks</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold_adapt_method =</span> threshold_method_quantile,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_adapt_method     =</span> model_method_none,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome_fn             =</span> outcome_attend</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The threshold trajectory shows how the system adapts under capacity constraints. After early fluctuations, the threshold stabilizes, indicating the referral rate has aligned with the target proportion.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_threshold_trajectory</span>(sim_out, <span class="at">save_path =</span> <span class="st">"figures/case1_threshold_trajectory.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To assess how adaptation shaped allocation and behavior, we summarize referral rates and attendance outcomes across blocks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># results tibble per block</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> sim_out<span class="sc">$</span>results</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># quick summaries</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>treat_by_block <span class="ot">&lt;-</span> res <span class="sc">|&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(block) <span class="sc">|&gt;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">n        =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">treated =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(treat), <span class="dv">1</span>),</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(outcome), <span class="dv">1</span>),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> dplyr<span class="sc">::</span><span class="fu">first</span>(<span class="fu">round</span>(threshold_used<span class="sc">*</span><span class="dv">1000</span>)<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(treat_by_block, <span class="at">caption =</span> <span class="st">"Block-level treatment and outcome rates with threshold used"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Block-level treatment and outcome rates with threshold used</caption>
<thead>
<tr class="header">
<th style="text-align: right;">block</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">treated</th>
<th style="text-align: right;">outcome</th>
<th style="text-align: right;">threshold</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">400</td>
<td style="text-align: right;">54.2</td>
<td style="text-align: right;">12.8</td>
<td style="text-align: right;">0.100</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">34.0</td>
<td style="text-align: right;">10.0</td>
<td style="text-align: right;">0.171</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">27.0</td>
<td style="text-align: right;">6.0</td>
<td style="text-align: right;">0.179</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">37.0</td>
<td style="text-align: right;">8.0</td>
<td style="text-align: right;">0.176</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">28.0</td>
<td style="text-align: right;">8.0</td>
<td style="text-align: right;">0.183</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">31.0</td>
<td style="text-align: right;">7.0</td>
<td style="text-align: right;">0.182</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">27.0</td>
<td style="text-align: right;">9.0</td>
<td style="text-align: right;">0.183</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">27.0</td>
<td style="text-align: right;">6.0</td>
<td style="text-align: right;">0.182</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">29.0</td>
<td style="text-align: right;">7.0</td>
<td style="text-align: right;">0.178</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">34.0</td>
<td style="text-align: right;">14.0</td>
<td style="text-align: right;">0.178</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">31.0</td>
<td style="text-align: right;">9.0</td>
<td style="text-align: right;">0.180</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">32.0</td>
<td style="text-align: right;">7.0</td>
<td style="text-align: right;">0.181</td>
</tr>
<tr class="odd">
<td style="text-align: right;">13</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">34.0</td>
<td style="text-align: right;">8.0</td>
<td style="text-align: right;">0.182</td>
</tr>
<tr class="even">
<td style="text-align: right;">14</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">27.0</td>
<td style="text-align: right;">11.0</td>
<td style="text-align: right;">0.183</td>
</tr>
<tr class="odd">
<td style="text-align: right;">15</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">21.0</td>
<td style="text-align: right;">5.0</td>
<td style="text-align: right;">0.182</td>
</tr>
<tr class="even">
<td style="text-align: right;">16</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">9.0</td>
<td style="text-align: right;">0.179</td>
</tr>
<tr class="odd">
<td style="text-align: right;">17</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">31.0</td>
<td style="text-align: right;">7.0</td>
<td style="text-align: right;">0.179</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">26.0</td>
<td style="text-align: right;">8.0</td>
<td style="text-align: right;">0.179</td>
</tr>
<tr class="odd">
<td style="text-align: right;">19</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">9.0</td>
<td style="text-align: right;">0.178</td>
</tr>
<tr class="even">
<td style="text-align: right;">20</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">29.0</td>
<td style="text-align: right;">9.0</td>
<td style="text-align: right;">0.178</td>
</tr>
<tr class="odd">
<td style="text-align: right;">21</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">10.0</td>
<td style="text-align: right;">0.178</td>
</tr>
<tr class="even">
<td style="text-align: right;">22</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">36.0</td>
<td style="text-align: right;">9.0</td>
<td style="text-align: right;">0.178</td>
</tr>
<tr class="odd">
<td style="text-align: right;">23</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">32.0</td>
<td style="text-align: right;">8.0</td>
<td style="text-align: right;">0.179</td>
</tr>
<tr class="even">
<td style="text-align: right;">24</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">9.0</td>
<td style="text-align: right;">0.180</td>
</tr>
<tr class="odd">
<td style="text-align: right;">25</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">25.0</td>
<td style="text-align: right;">6.0</td>
<td style="text-align: right;">0.180</td>
</tr>
<tr class="even">
<td style="text-align: right;">26</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">24.0</td>
<td style="text-align: right;">8.0</td>
<td style="text-align: right;">0.179</td>
</tr>
<tr class="odd">
<td style="text-align: right;">27</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">37.0</td>
<td style="text-align: right;">7.0</td>
<td style="text-align: right;">0.177</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>To visualize how treatment effects evolve across the risk spectrum, we fit a spline-based model using counterfactual risk representations. We first reduce the counterfactual risk space via PCA, retaining key variation in risk, and then estimate smooth outcome curves separately for treated and untreated patients. This step displays the fitted conditional mean functions for treated and untreated patients. It is the first stage of the adaptive RD estimator, from which we later extract the treatment effect at the threshold.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate treatment effect using splines</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>fit_out <span class="ot">&lt;-</span> <span class="fu">estimate_spline</span>(sim_out, <span class="at">family=</span><span class="fu">binomial</span>())</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_spline_curves</span>(fit_out, sim_out, pce_predict, attendance_prob, cohort_df, <span class="at">save_path =</span> <span class="st">"figures/case1_spline_curves.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We now evaluate the estimated treatment effect at the adaptive threshold and compare it to the true effect from the data-generating process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_ate_at_threshold</span>(fit_out, sim_out, cohort_df, pce_predict, attendance_prob)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Metric</th>
<th style="text-align: center;">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Estimated ATE</td>
<td style="text-align: center;">0.240</td>
</tr>
<tr class="even">
<td style="text-align: left;">95% CI</td>
<td style="text-align: center;">[0.193, 0.288]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Truth</td>
<td style="text-align: center;">0.247</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bias</td>
<td style="text-align: center;">-0.007</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Coverage</td>
<td style="text-align: center;">Yes</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fit_out <span class="ot">&lt;-</span> <span class="fu">ate_naive</span>(sim_out, <span class="at">family=</span><span class="fu">binomial</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This estimate reflects performance at the end of the simulation, after all patients have been processed. To evaluate how early data supports estimation, we also compute effects at earlier points in time, such as after 1,000 and 2,000 patients.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># n = 1000</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>sim_out_1000 <span class="ot">&lt;-</span> <span class="fu">within</span>(sim_out, results <span class="ot">&lt;-</span> results[<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, ])</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>fit_out_1000 <span class="ot">&lt;-</span> <span class="fu">estimate_spline</span>(sim_out_1000, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_spline_curves</span>(fit_out_1000, sim_out_1000, pce_predict, attendance_prob, cohort_df, <span class="at">save_path =</span> <span class="st">"figures/case1_spline_curves_1000.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># n = 2000</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>sim_out_2000 <span class="ot">&lt;-</span> <span class="fu">within</span>(sim_out, results <span class="ot">&lt;-</span> results[<span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>, ])</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>fit_out_2000 <span class="ot">&lt;-</span> <span class="fu">estimate_spline</span>(sim_out_2000, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_spline_curves</span>(fit_out_2000, sim_out_2000, pce_predict, attendance_prob, cohort_df, </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="at">save_path =</span> <span class="st">"figures/case1_spline_curves_2000.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We now extract the local ATE at earlier time points to assess whether the threshold effect can be estimated reliably before the full sample is observed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_ate_at_threshold</span>(fit_out_1000, sim_out_1000, cohort_df, pce_predict, attendance_prob)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Metric</th>
<th style="text-align: center;">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Estimated ATE</td>
<td style="text-align: center;">0.225</td>
</tr>
<tr class="even">
<td style="text-align: left;">95% CI</td>
<td style="text-align: center;">[0.167, 0.284]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Truth</td>
<td style="text-align: center;">0.248</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bias</td>
<td style="text-align: center;">-0.022</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Coverage</td>
<td style="text-align: center;">Yes</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_ate_at_threshold</span>(fit_out_2000, sim_out_2000, cohort_df, pce_predict, attendance_prob)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Metric</th>
<th style="text-align: center;">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Estimated ATE</td>
<td style="text-align: center;">0.231</td>
</tr>
<tr class="even">
<td style="text-align: left;">95% CI</td>
<td style="text-align: center;">[0.172, 0.291]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Truth</td>
<td style="text-align: center;">0.247</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bias</td>
<td style="text-align: center;">-0.016</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Coverage</td>
<td style="text-align: center;">Yes</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="prioritizing-patients-for-a-new-lipid-lowering-medication" class="level3">
<h3 class="anchored" data-anchor-id="prioritizing-patients-for-a-new-lipid-lowering-medication">Prioritizing patients for a new lipid-lowering medication</h3>
<p>In this second scenario, we move from a binary outcome (program attendance) to a continuous clinical outcome: the change in LDL cholesterol after starting a lipid-lowering medication. The adaptive threshold procedure is unchanged, but the underlying clinical question now differs. Instead of rationing limited program slots, we are prioritizing patients for a new therapy whose benefit increases with baseline risk.</p>
<p>Cholesterol-lowering medications, such as statins and newer agents like PCSK9 inhibitors, lower LDL cholesterol by 30–60%, with larger absolute reductions for patients who start with higher cholesterol. Our simulation mimics this: untreated patients may experience some background drift, while treated patients receive a reduction in LDL that grows with their baseline risk. This setup allows us to examine adaptive RD in a context where treatment effects are continuous and heterogeneous, contrasting with the earlier scenario’s binary outcome and resource constraint.</p>
<p>Formally, the data-generating process models the expected change in LDL cholesterol as a function of baseline risk and treatment assignment, with the treatment effect increasing for higher-risk patients:</p>
<p><span class="math display">\[
\mathbb{E}[Y_i \mid A_i=a, X_i=x]
= \gamma_0 + \gamma_1\big(\text{Chol}_i-130\big)
+ a\Big(\delta_0 + \delta_1\big(\text{Chol}_i-130\big)\Big),
\]</span> where <span class="math inline">\(\gamma_0,\gamma_1\)</span> represent background drift without therapy, and <span class="math inline">\(\delta_0, \delta_1\)</span> capture the medication effect that increases with baseline cholesterol. This is implemented in R as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome: Follow-up total cholesterol level-----</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>cholest_params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment_effect_intercept =</span>   <span class="fl">0.00</span>,  <span class="co"># shift for treated</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment_effect_slope     =</span> <span class="sc">-</span><span class="fl">10.00</span>,  <span class="co"># effect scales with risk</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">reference_intercept        =</span>  <span class="fl">2.00</span>,   <span class="co"># baseline drift</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">reference_slope            =</span>  <span class="fl">0.00</span>,   <span class="co"># dependence on baseline_sbp</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">within_sd                  =</span>  <span class="fl">5.00</span>    <span class="co"># residual SD</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean model: expected change in cholesterol</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>cholest_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(cohort_df, idx, risk_baseline, treat, <span class="at">params =</span> cholest_params) {</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> params<span class="sc">$</span>reference_intercept <span class="sc">+</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    params<span class="sc">$</span>reference_slope <span class="sc">*</span> risk_baseline <span class="sc">+</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    treat <span class="sc">*</span> (params<span class="sc">$</span>treatment_effect_intercept <span class="sc">+</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>               params<span class="sc">$</span>treatment_effect_slope <span class="sc">*</span> risk_baseline)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  mu</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome generator: draws cholesterol change given the mean model</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>outcome_cholest <span class="ot">&lt;-</span> <span class="cf">function</span>(cohort_df, idx, risk_baseline, treat, <span class="at">params =</span> cholest_params) {</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">cholest_mean</span>(cohort_df, idx, risk_baseline, treat, <span class="at">params =</span> params)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">length</span>(idx), <span class="at">mean =</span> mu, <span class="at">sd =</span> params<span class="sc">$</span>within_sd)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now simulate how treatment decisions unfold under this continuous outcome setting. The <code>simulate_design()</code> function again processes patients in chronological blocks: it calculates risk using <code>pce_predict()</code>, applies the adaptive threshold to assign medication, and generates cholesterol outcomes using <code>outcome_cholest()</code>. As before, the prediction model is held fixed, so changes in treatment allocation arise solely from threshold adaptation rather than model updating.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- run the simulation ----</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>sim_out <span class="ot">&lt;-</span> <span class="fu">simulate_design</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">cohort_df              =</span> cohort_df,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk_fn                =</span> pce_predict,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">initial_block_size     =</span> <span class="dv">400</span>,   <span class="co"># warm-up</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">block_size             =</span> <span class="dv">100</span>,   <span class="co"># subsequent blocks</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_blocks               =</span> <span class="dv">26</span>,    <span class="co"># total post–warm-up blocks</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold_adapt_method =</span> threshold_method_quantile,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_adapt_method     =</span> model_method_none,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome_fn             =</span> outcome_cholest</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As in the first scenario, the threshold fluctuates early while the system learns but eventually stabilizes, here converging near 18%, marking the risk level at which treatment becomes consistently prioritized.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_threshold_trajectory</span>(sim_out, <span class="at">save_path =</span> <span class="st">"figures/case2_threshold_trajectory.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As before, we summarize each block to monitor how the adaptive threshold influences treatment allocation and average cholesterol outcomes over time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># results tibble per block</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> sim_out<span class="sc">$</span>results</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># quick summaries</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>treat_by_block <span class="ot">&lt;-</span> res <span class="sc">|&gt;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(block) <span class="sc">|&gt;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">n        =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(),</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">treated =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(treat), <span class="dv">1</span>),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(outcome), <span class="dv">1</span>),</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> dplyr<span class="sc">::</span><span class="fu">first</span>(<span class="fu">round</span>(threshold_used<span class="sc">*</span><span class="dv">1000</span>)<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(treat_by_block, <span class="at">caption =</span> <span class="st">"Block-level treatment and outcome rates with threshold used"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Block-level treatment and outcome rates with threshold used</caption>
<thead>
<tr class="header">
<th style="text-align: right;">block</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">treated</th>
<th style="text-align: right;">outcome</th>
<th style="text-align: right;">threshold</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">400</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">100.8</td>
<td style="text-align: right;">0.100</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">120.8</td>
<td style="text-align: right;">0.176</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">38.9</td>
<td style="text-align: right;">0.167</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">238.9</td>
<td style="text-align: right;">0.170</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">39.2</td>
<td style="text-align: right;">0.158</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">147.9</td>
<td style="text-align: right;">0.161</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">45.1</td>
<td style="text-align: right;">0.159</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">150.0</td>
<td style="text-align: right;">0.165</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">64.1</td>
<td style="text-align: right;">0.165</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">14.3</td>
<td style="text-align: right;">0.165</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">158.0</td>
<td style="text-align: right;">0.168</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">68.2</td>
<td style="text-align: right;">0.169</td>
</tr>
<tr class="odd">
<td style="text-align: right;">13</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">158.1</td>
<td style="text-align: right;">0.169</td>
</tr>
<tr class="even">
<td style="text-align: right;">14</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">118.9</td>
<td style="text-align: right;">0.165</td>
</tr>
<tr class="odd">
<td style="text-align: right;">15</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">117.4</td>
<td style="text-align: right;">0.164</td>
</tr>
<tr class="even">
<td style="text-align: right;">16</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">122.4</td>
<td style="text-align: right;">0.167</td>
</tr>
<tr class="odd">
<td style="text-align: right;">17</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">130.7</td>
<td style="text-align: right;">0.171</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">74.6</td>
<td style="text-align: right;">0.172</td>
</tr>
<tr class="odd">
<td style="text-align: right;">19</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">24.9</td>
<td style="text-align: right;">0.173</td>
</tr>
<tr class="even">
<td style="text-align: right;">20</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">46.2</td>
<td style="text-align: right;">0.173</td>
</tr>
<tr class="odd">
<td style="text-align: right;">21</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">96.0</td>
<td style="text-align: right;">0.172</td>
</tr>
<tr class="even">
<td style="text-align: right;">22</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">122.4</td>
<td style="text-align: right;">0.173</td>
</tr>
<tr class="odd">
<td style="text-align: right;">23</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">67.5</td>
<td style="text-align: right;">0.173</td>
</tr>
<tr class="even">
<td style="text-align: right;">24</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">115.8</td>
<td style="text-align: right;">0.177</td>
</tr>
<tr class="odd">
<td style="text-align: right;">25</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">89.2</td>
<td style="text-align: right;">0.177</td>
</tr>
<tr class="even">
<td style="text-align: right;">26</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">44.3</td>
<td style="text-align: right;">0.177</td>
</tr>
<tr class="odd">
<td style="text-align: right;">27</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">55.1</td>
<td style="text-align: right;">0.177</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As before, we estimate the average potential outcomes under each treatment condition across the risk spectrum, using data from the full sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate treatment effect using splines</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>fit_out <span class="ot">&lt;-</span> <span class="fu">estimate_spline</span>(sim_out, <span class="at">family=</span><span class="fu">gaussian</span>())</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_spline_curves</span>(</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  fit_out, sim_out, pce_predict, cholest_mean, cohort_df,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_lab  =</span> <span class="st">"Change in Cholesterol, mg/dL"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"No Medication"</span>, <span class="st">"Medication"</span>),</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_path =</span> <span class="st">"figures/case2_spline_curves.rds"</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We now evaluate the estimated treatment effect at the adaptive threshold. As in earlier scenarios, we use the fitted conditional mean functions to compute the local ATE at the most recent threshold. This allows us to assess whether the treatment effect, which increases with baseline cholesterol, is accurately captured by the adaptive RD estimator.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -- ATE at last risk threshold</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_ate_at_threshold</span>(fit_out, sim_out, cohort_df, pce_predict, cholest_mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Metric</th>
<th style="text-align: center;">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Estimated ATE</td>
<td style="text-align: center;">-2.035</td>
</tr>
<tr class="even">
<td style="text-align: left;">95% CI</td>
<td style="text-align: center;">[-3.063, -1.006]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Truth</td>
<td style="text-align: center;">-1.742</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bias</td>
<td style="text-align: center;">-0.293</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Coverage</td>
<td style="text-align: center;">Yes</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="balancing-benefit-and-burden-through-number-needed-to-treat" class="level3">
<h3 class="anchored" data-anchor-id="balancing-benefit-and-burden-through-number-needed-to-treat">Balancing benefit and burden through number needed to treat</h3>
<p>In this third scenario, we again consider the use of a lipid-lowering medication, but the decision threshold now adapts based on a clinically meaningful performance metric: the number needed to treat (NNT). Unlike the prior scenario, where the threshold adapted to maintain a fixed treatment rate, the NNT-based rule seeks to treat patients for whom the expected benefit is large enough to justify the burden of treatment. This setup illustrates how adaptive RD designs can be tailored to reflect not just resource constraints, but benefit–burden trade-offs in clinical decision-making.</p>
<p>NNT provides a clinically intuitive way to interpret treatment benefit by asking how many patients must be treated for one to meaningfully benefit. For binary outcomes, it is the inverse of the risk difference. For continuous outcomes like LDL reduction, we translate the treatment effect into a standardized effect size (Cohen’s <em>d</em>) and compute NNT using [ = , ] where () is the standard normal CDF. Smaller NNT values indicate stronger benefit relative to treatment burden. In this scenario, we target an NNT of 3, meaning that roughly two out of every three treated patients are expected to experience a clinically meaningful reduction in LDL cholesterol.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>target_nnt <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># 3 persons</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_cohen_d_to_nnt</span>(target_nnt, <span class="at">save_path =</span> <span class="st">"figures/case3_cohen_d_to_nnt.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From the plot, we see that a target NNT of 3 corresponds to a Cohen’s <span class="math inline">\(d\)</span> of 0.61. This value defines the effect size we aim to achieve through threshold adaptation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>target_d <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="dv">2</span>) <span class="sc">*</span> <span class="fu">qnorm</span>(<span class="fl">0.5</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> target_nnt))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>scales<span class="sc">::</span><span class="fu">number</span>(target_d, <span class="at">accuracy =</span> <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0.61"</code></pre>
</div>
</div>
<p>This is considered a medium to large effect size. In our simulation, each one-unit increase in PCE-predicted risk corresponds to an average 10 mg/dL LDL reduction from treatment, with a residual standard deviation of 5 mg/dL. As a result, Cohen’s <span class="math inline">\(d\)</span> increases linearly with risk, starting at 0 for low-risk patients and reaching 2 for those at 100% risk. The figure below plots this relationship and indicates the risk threshold that yields the target NNT.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_risk_to_cohen_d</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  target_d,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  cholest_params<span class="sc">$</span>treatment_effect_slope, </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  cholest_params<span class="sc">$</span>within_sd,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_path =</span> <span class="st">"figures/case3_risk_to_cohen_d.rds"</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The solid line shows how Cohen’s <span class="math inline">\(d\)</span> increases linearly with risk, reflecting that treatment benefit scales with risk.</p>
<p>We define the adaptive threshold rule to search for the risk level where the estimated treatment effect achieves the target NNT.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NNT adaptation: set threshold so that we target a specific NNT</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>threshold_method_nnt <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">type               =</span> <span class="st">"nnt"</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">initial_threshold  =</span> <span class="fl">0.10</span>,       <span class="co"># initial_threshold,</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">desired_nnt        =</span> target_nnt   <span class="co"># Target NNT</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Like before, we begin with an initial threshold of 10%, then update it after each patient block to target an NNT of 3. We estimate the treatment effect across risk values using past data, standardize it via the pooled standard deviation, and search for the risk level yielding a Cohen’s <span class="math inline">\(d\)</span> near 0.61 (corresponding to NNT = 3). Let this estimate after block <span class="math inline">\(b\)</span> be <span class="math inline">\(r_{*,b}\)</span>. To reduce noise, we smooth updates by averaging the new and previous thresholds: <span class="math display">\[
r_{b+1} = \tfrac{1}{2} r_{*,b} + \tfrac{1}{2} r_b,
\]</span> where <span class="math inline">\(r_b\)</span> is the risk used in block <span class="math inline">\(b\)</span>. This procedure assumes the treatment effect increases with risk—a strong assumption, but one that holds in our setup, since higher-risk patients are expected to see larger LDL reductions.</p>
<p>We now rerun the simulation, this time using the NNT-based rule to adapt the threshold based on estimated treatment benefit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- run the simulation ----</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>sim_out <span class="ot">&lt;-</span> <span class="fu">simulate_design</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">cohort_df              =</span> cohort_df,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk_fn                =</span> pce_predict,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">initial_block_size     =</span> <span class="dv">400</span>,   <span class="co"># warm-up</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">block_size             =</span> <span class="dv">100</span>,   <span class="co"># subsequent blocks</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_blocks               =</span> <span class="dv">26</span>,    <span class="co"># total post–warm-up blocks</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold_adapt_method =</span> threshold_method_nnt,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_adapt_method     =</span> model_method_none,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome_fn             =</span> outcome_cholest</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We plot how the threshold evolves under the NNT-based rule. After early fluctuations, it settles near 30%, indicating that patients above this risk level are consistently prioritized for treatment based on the target NNT.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_threshold_trajectory</span>(sim_out, <span class="at">save_path =</span> <span class="st">"figures/case3_threshold_trajectory.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We also report the proportion of patients treated (i.e., prescribed the medication) and the average change in LDL cholesterol (i.e., the outcome) in each block.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># results tibble per block</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> sim_out<span class="sc">$</span>results</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># quick summaries</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>treat_by_block <span class="ot">&lt;-</span> res <span class="sc">|&gt;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(block) <span class="sc">|&gt;</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">n        =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(),</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">treated =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(treat), <span class="dv">1</span>),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(outcome), <span class="dv">1</span>),</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> dplyr<span class="sc">::</span><span class="fu">first</span>(<span class="fu">round</span>(threshold_used<span class="sc">*</span><span class="dv">1000</span>)<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(treat_by_block, <span class="at">caption =</span> <span class="st">"Block-level treatment and outcome rates with threshold used"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Block-level treatment and outcome rates with threshold used</caption>
<thead>
<tr class="header">
<th style="text-align: right;">block</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">treated</th>
<th style="text-align: right;">outcome</th>
<th style="text-align: right;">threshold</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">400</td>
<td style="text-align: right;">54.5</td>
<td style="text-align: right;">81.3</td>
<td style="text-align: right;">0.100</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">26.0</td>
<td style="text-align: right;">108.7</td>
<td style="text-align: right;">0.161</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">23.0</td>
<td style="text-align: right;">103.7</td>
<td style="text-align: right;">0.224</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">17.0</td>
<td style="text-align: right;">92.6</td>
<td style="text-align: right;">0.221</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">23.0</td>
<td style="text-align: right;">47.5</td>
<td style="text-align: right;">0.213</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">19.0</td>
<td style="text-align: right;">181.4</td>
<td style="text-align: right;">0.212</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">20.0</td>
<td style="text-align: right;">135.6</td>
<td style="text-align: right;">0.207</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">17.0</td>
<td style="text-align: right;">209.0</td>
<td style="text-align: right;">0.203</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">27.0</td>
<td style="text-align: right;">90.1</td>
<td style="text-align: right;">0.204</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">29.0</td>
<td style="text-align: right;">54.6</td>
<td style="text-align: right;">0.209</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">19.0</td>
<td style="text-align: right;">160.4</td>
<td style="text-align: right;">0.220</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">19.0</td>
<td style="text-align: right;">166.8</td>
<td style="text-align: right;">0.236</td>
</tr>
<tr class="odd">
<td style="text-align: right;">13</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">17.0</td>
<td style="text-align: right;">216.5</td>
<td style="text-align: right;">0.245</td>
</tr>
<tr class="even">
<td style="text-align: right;">14</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">14.0</td>
<td style="text-align: right;">236.3</td>
<td style="text-align: right;">0.260</td>
</tr>
<tr class="odd">
<td style="text-align: right;">15</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">11.0</td>
<td style="text-align: right;">121.3</td>
<td style="text-align: right;">0.279</td>
</tr>
<tr class="even">
<td style="text-align: right;">16</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">8.0</td>
<td style="text-align: right;">200.2</td>
<td style="text-align: right;">0.320</td>
</tr>
<tr class="odd">
<td style="text-align: right;">17</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">9.0</td>
<td style="text-align: right;">2.0</td>
<td style="text-align: right;">0.336</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">12.0</td>
<td style="text-align: right;">227.2</td>
<td style="text-align: right;">0.332</td>
</tr>
<tr class="odd">
<td style="text-align: right;">19</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">8.0</td>
<td style="text-align: right;">183.2</td>
<td style="text-align: right;">0.333</td>
</tr>
<tr class="even">
<td style="text-align: right;">20</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">7.0</td>
<td style="text-align: right;">207.5</td>
<td style="text-align: right;">0.319</td>
</tr>
<tr class="odd">
<td style="text-align: right;">21</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">13.0</td>
<td style="text-align: right;">132.8</td>
<td style="text-align: right;">0.294</td>
</tr>
<tr class="even">
<td style="text-align: right;">22</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">12.0</td>
<td style="text-align: right;">161.6</td>
<td style="text-align: right;">0.284</td>
</tr>
<tr class="odd">
<td style="text-align: right;">23</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">11.0</td>
<td style="text-align: right;">165.3</td>
<td style="text-align: right;">0.281</td>
</tr>
<tr class="even">
<td style="text-align: right;">24</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">15.0</td>
<td style="text-align: right;">164.1</td>
<td style="text-align: right;">0.276</td>
</tr>
<tr class="odd">
<td style="text-align: right;">25</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">14.0</td>
<td style="text-align: right;">37.7</td>
<td style="text-align: right;">0.273</td>
</tr>
<tr class="even">
<td style="text-align: right;">26</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">16.0</td>
<td style="text-align: right;">65.7</td>
<td style="text-align: right;">0.273</td>
</tr>
<tr class="odd">
<td style="text-align: right;">27</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">15.0</td>
<td style="text-align: right;">63.8</td>
<td style="text-align: right;">0.274</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As before, we estimate the average potential outcomes under each treatment condition across the risk spectrum, using data from the full sample. This step reveals how treatment benefit varies with predicted risk and allows us to evaluate whether the adaptive RD estimator recovers the expected heterogeneity.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate treatment effect using splines</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>fit_out <span class="ot">&lt;-</span> <span class="fu">estimate_spline</span>(sim_out, <span class="at">family=</span><span class="fu">gaussian</span>())</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_spline_curves</span>(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  fit_out, sim_out, pce_predict, cholest_mean, cohort_df,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_lab  =</span> <span class="st">"Change in Cholesterol, mg/dL"</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"No Medication"</span>, <span class="st">"Medication"</span>),</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_path =</span> <span class="st">"figures/case3_spline_curves.rds"</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We now evaluate the estimated treatment effect at the adaptive threshold. As in earlier scenarios, we extract the local ATE using the fitted conditional means. This allows us to assess whether the adaptive RD estimator accurately recovers the effect size that guided the NNT-based threshold adaptation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -- ATE at last risk threshold</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_ate_at_threshold</span>(fit_out, sim_out, cohort_df, pce_predict, cholest_mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Metric</th>
<th style="text-align: center;">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Estimated ATE</td>
<td style="text-align: center;">-2.954</td>
</tr>
<tr class="even">
<td style="text-align: left;">95% CI</td>
<td style="text-align: center;">[-3.902, -2.007]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Truth</td>
<td style="text-align: center;">-2.696</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bias</td>
<td style="text-align: center;">-0.259</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Coverage</td>
<td style="text-align: center;">Yes</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="recalibrating-the-risk-model" class="level3">
<h3 class="anchored" data-anchor-id="recalibrating-the-risk-model">Recalibrating the risk model</h3>
<p>In the fourth scenario, we shift focus from adapting the treatment threshold to updating the prediction model itself. The outcome is a cardiovascular event, simulated as a binary variable indicating whether the patient experiences an ASCVD event during follow-up. Specifically, we consider a setting where the original risk model is miscalibrated—underestimating cardiovascular event risk for high-risk patients and overestimating it for low-risk ones. To address this mismatch, we implement a recalibration strategy that applies an affine transformation to the model’s linear predictor, allowing it to better align predicted and actual risks over time.</p>
<p>The simulated outcome is the occurrence of an ASCVD event, generated using a miscalibrated version of the pooled cohort equations. Specifically, for each patient, we recompute baseline risk and apply an affine transformation to the linear predictor to introduce systematic calibration error. Let ( {R}_{i,1} ) be the original predicted risk, transformed to the log–log scale as ( i =* (-(1 - {R}{i,1})) ). The true event probability is then given by [ p_i = 1 - , ] where ( A_i ) indicates treatment, ( _0 ) and ( _1 ) control baseline drift and slope, and ( ) represents the treatment effect. Events are drawn as Bernoulli(( p_i )), creating a nonlinear relationship between risk and outcome that challenges the adaptive estimator.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Outcome: Cardiovascular event -----</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>cvd_params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment_effect_intercept =</span>  <span class="fl">0.4</span>,    <span class="co"># shift for treated</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_intercept         =</span>  <span class="fl">0.1</span>,    <span class="co"># baseline drift</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_slope             =</span>  <span class="fl">0.9</span>     <span class="co"># dependence on baseline_sbp</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Simulated probability (pce model is inaccurate) ----</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>cvd_prob <span class="ot">&lt;-</span> <span class="cf">function</span>(cohort_df, idx, risk_baseline, treat, <span class="at">params =</span> cvd_params) {</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Copy df for local edits</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> cohort_df[idx, ]</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recompute baseline risk with updated labels</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  risk_new <span class="ot">&lt;-</span> <span class="fu">pce_predict</span>(df, <span class="at">coefs =</span> pce_coefs, <span class="at">coef_adjust =</span> <span class="cn">NULL</span>)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get on linear predictor scale</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  lp_new <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="sc">-</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>risk_new))</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply affine transformation</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  lp_new <span class="ot">&lt;-</span> params<span class="sc">$</span>baseline_intercept <span class="sc">+</span> </span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    params<span class="sc">$</span>baseline_slope <span class="sc">*</span> lp_new <span class="sc">+</span> </span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    params<span class="sc">$</span>treatment_effect_intercept <span class="sc">*</span> treat</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform back to response scale</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(lp_new))</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return probability</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>outcome_cvd <span class="ot">&lt;-</span> <span class="cf">function</span>(cohort_df, idx, risk_baseline, treat, <span class="at">params =</span> cvd_params) {</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">cvd_prob</span>(cohort_df, idx, risk_baseline, treat, params)</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>  stats<span class="sc">::</span><span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">length</span>(idx), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p)</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We visualize the mismatch between predicted and true risk by plotting how the affine transformation alters the original predictions. The model tends to underestimate risk for higher-risk patients and overestimate it for lower-risk ones, motivating the need for recalibration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_affine_risk_transform</span>(cvd_params<span class="sc">$</span>baseline_slope, cvd_params<span class="sc">$</span>baseline_intercept,</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">save_path =</span> <span class="st">"figures/case4_risk_transform.rds"</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We now define the model adaptation strategy using recalibration, as shown in the next block. Recalibration modifies the model’s linear predictor through an affine transformation to better align predictions with observed outcomes. It begins from the original PCE coefficients and updates them gradually. The <code>shrinkage_factor</code> controls how strongly new estimates are pulled toward the original values, using a weight of (1 / (1 + n / )), where (n) is the number of patients contributing to the update. This ensures the model adapts slowly rather than overreacting to recent data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recalibrate model</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>model_method_recalibrate <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type        =</span> <span class="st">"recalibrate"</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_original  =</span> pce_coefs,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_adjusted  =</span> <span class="cn">NULL</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">shrinkage_factor   =</span> <span class="dv">3000</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now simulate the full adaptive design under this recalibrated model. As in previous scenarios, patients are processed in chronological blocks. The recalibrated model is used to compute risk, and the adaptive threshold is updated to maintain the desired referral rate. Outcomes are then generated using the cardiovascular event mechanism. This setup allows us to examine how model adaptation interacts with threshold adaptation in guiding treatment decisions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- run the simulation ----</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>sim_out <span class="ot">&lt;-</span> <span class="fu">simulate_design</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">cohort_df              =</span> cohort_df,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk_fn                =</span> pce_predict,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">initial_block_size     =</span> <span class="dv">400</span>,   <span class="co"># warm-up</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">block_size             =</span> <span class="dv">100</span>,   <span class="co"># subsequent blocks</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_blocks               =</span> <span class="dv">26</span>,    <span class="co"># total post–warm-up blocks</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold_adapt_method =</span> threshold_method_quantile,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_adapt_method     =</span> model_method_recalibrate,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome_fn             =</span> outcome_cvd</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To assess how recalibration alters individual risk estimates over time, we track how predicted risk evolves for the first 100 patients in the cohort. As the model updates, these patients’ risk scores are re-evaluated at each block, illustrating how gradual calibration shifts can change clinical prioritization.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_risk_trajectory</span>(sim_out, <span class="at">save_path =</span> <span class="st">"figures/case4_risk_trajectory.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We report block-level referral rates and ASCVD event rates (treated = referral; outcome = ASCVD event) to monitor how model and threshold updates affect allocation and observed incidence.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># results tibble per block</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> sim_out<span class="sc">$</span>results</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># quick summaries</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>treat_by_block <span class="ot">&lt;-</span> res <span class="sc">|&gt;</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(block) <span class="sc">|&gt;</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">n        =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(),</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">treated =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(treat), <span class="dv">1</span>),</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(outcome), <span class="dv">1</span>),</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> dplyr<span class="sc">::</span><span class="fu">first</span>(<span class="fu">round</span>(threshold_used<span class="sc">*</span><span class="dv">1000</span>)<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(treat_by_block, <span class="at">caption =</span> <span class="st">"Block-level treatment and outcome rates with threshold used"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Block-level treatment and outcome rates with threshold used</caption>
<thead>
<tr class="header">
<th style="text-align: right;">block</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">treated</th>
<th style="text-align: right;">outcome</th>
<th style="text-align: right;">threshold</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">400</td>
<td style="text-align: right;">46.8</td>
<td style="text-align: right;">23.2</td>
<td style="text-align: right;">0.100</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">37.0</td>
<td style="text-align: right;">20.0</td>
<td style="text-align: right;">0.158</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">37.0</td>
<td style="text-align: right;">23.0</td>
<td style="text-align: right;">0.171</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">29.0</td>
<td style="text-align: right;">26.0</td>
<td style="text-align: right;">0.174</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">40.0</td>
<td style="text-align: right;">29.0</td>
<td style="text-align: right;">0.171</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">27.0</td>
<td style="text-align: right;">20.0</td>
<td style="text-align: right;">0.181</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">29.0</td>
<td style="text-align: right;">17.0</td>
<td style="text-align: right;">0.183</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">35.0</td>
<td style="text-align: right;">25.0</td>
<td style="text-align: right;">0.185</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">26.0</td>
<td style="text-align: right;">20.0</td>
<td style="text-align: right;">0.189</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">40.0</td>
<td style="text-align: right;">26.0</td>
<td style="text-align: right;">0.190</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">24.0</td>
<td style="text-align: right;">21.0</td>
<td style="text-align: right;">0.195</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">34.0</td>
<td style="text-align: right;">24.0</td>
<td style="text-align: right;">0.192</td>
</tr>
<tr class="odd">
<td style="text-align: right;">13</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">35.0</td>
<td style="text-align: right;">24.0</td>
<td style="text-align: right;">0.197</td>
</tr>
<tr class="even">
<td style="text-align: right;">14</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">35.0</td>
<td style="text-align: right;">18.0</td>
<td style="text-align: right;">0.201</td>
</tr>
<tr class="odd">
<td style="text-align: right;">15</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">28.0</td>
<td style="text-align: right;">14.0</td>
<td style="text-align: right;">0.202</td>
</tr>
<tr class="even">
<td style="text-align: right;">16</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">32.0</td>
<td style="text-align: right;">23.0</td>
<td style="text-align: right;">0.201</td>
</tr>
<tr class="odd">
<td style="text-align: right;">17</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">34.0</td>
<td style="text-align: right;">21.0</td>
<td style="text-align: right;">0.201</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">37.0</td>
<td style="text-align: right;">16.0</td>
<td style="text-align: right;">0.202</td>
</tr>
<tr class="odd">
<td style="text-align: right;">19</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">33.0</td>
<td style="text-align: right;">23.0</td>
<td style="text-align: right;">0.204</td>
</tr>
<tr class="even">
<td style="text-align: right;">20</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">17.0</td>
<td style="text-align: right;">0.203</td>
</tr>
<tr class="odd">
<td style="text-align: right;">21</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">27.0</td>
<td style="text-align: right;">16.0</td>
<td style="text-align: right;">0.205</td>
</tr>
<tr class="even">
<td style="text-align: right;">22</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">27.0</td>
<td style="text-align: right;">23.0</td>
<td style="text-align: right;">0.204</td>
</tr>
<tr class="odd">
<td style="text-align: right;">23</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">18.0</td>
<td style="text-align: right;">0.203</td>
</tr>
<tr class="even">
<td style="text-align: right;">24</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">19.0</td>
<td style="text-align: right;">0.203</td>
</tr>
<tr class="odd">
<td style="text-align: right;">25</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">17.0</td>
<td style="text-align: right;">0.203</td>
</tr>
<tr class="even">
<td style="text-align: right;">26</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">35.0</td>
<td style="text-align: right;">22.0</td>
<td style="text-align: right;">0.203</td>
</tr>
<tr class="odd">
<td style="text-align: right;">27</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">37.0</td>
<td style="text-align: right;">18.0</td>
<td style="text-align: right;">0.204</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We now estimate the conditional mean outcome curves under each treatment arm across the risk spectrum. This step visualizes how predicted risk relates to event probability for treated and untreated patients.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate treatment effect using splines</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>fit_out <span class="ot">&lt;-</span> <span class="fu">estimate_spline</span>(sim_out, <span class="at">family=</span><span class="fu">binomial</span>())</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_spline_curves</span>(fit_out, sim_out, pce_predict, cvd_prob, cohort_df,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_lab  =</span> <span class="st">"Probability of cardiovascular event"</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"No Medication"</span>, <span class="st">"Medication"</span>),</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_path =</span> <span class="st">"figures/case4_spline_curves.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we evaluate the estimated treatment effect at the most recent threshold by computing the local ATE using the fitted conditional mean functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -- ATE at last risk threshold</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_ate_at_threshold</span>(fit_out, sim_out, cohort_df, pce_predict, cvd_prob)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Metric</th>
<th style="text-align: center;">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Estimated ATE</td>
<td style="text-align: center;">0.132</td>
</tr>
<tr class="even">
<td style="text-align: left;">95% CI</td>
<td style="text-align: center;">[0.039, 0.225]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Truth</td>
<td style="text-align: center;">0.090</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bias</td>
<td style="text-align: center;">0.042</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Coverage</td>
<td style="text-align: center;">Yes</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="revising-model-to-remove-race-and-gender" class="level3">
<h3 class="anchored" data-anchor-id="revising-model-to-remove-race-and-gender">Revising model to remove race and gender</h3>
<p>In the final scenario, we simulate a model revision that removes race and gender from the risk prediction model. This reflects recent efforts to eliminate demographic variables from clinical algorithms. We evaluate how such changes affect predicted risk, treatment allocation, and estimation of treatment effects.</p>
<p>The code block below specifies the model revision strategy. Starting from the original PCE coefficients, we remove the terms for race and gender and use the revised model to compute updated risk scores. The shrinkage factor is again applied to gradually blend the revised coefficients with the original ones as more data accumulate, providing a smoothed transition away from demographic-based predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Revise model</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>model_method_revise <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type           =</span> <span class="st">"revise"</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_original  =</span> pce_coefs,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_adjusted  =</span> <span class="cn">NULL</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">shrinkage_factor   =</span> <span class="dv">3000</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below, we simulate the full adaptive design using the revised model without race and gender. Risk is recalculated using the updated coefficients, and both the threshold and model continue to adapt over time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">#--- run the simulation ----</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>sim_out <span class="ot">&lt;-</span> <span class="fu">simulate_design</span>(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">cohort_df              =</span> cohort_df,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk_fn                =</span> pce_predict,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">initial_block_size     =</span> <span class="dv">400</span>,   <span class="co"># warm-up</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">block_size             =</span> <span class="dv">100</span>,   <span class="co"># subsequent blocks</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_blocks               =</span> <span class="dv">26</span>,    <span class="co"># total post–warm-up blocks</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold_adapt_method =</span> threshold_method_quantile,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_adapt_method     =</span> model_method_revise,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome_fn             =</span> outcome_cvd</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We plot how predicted risks evolve for the first 100 patients under the revised model to illustrate how risk estimates change over time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_risk_trajectory</span>(sim_out, <span class="at">save_path =</span> <span class="st">"figures/case5_risk_trajectory.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We now estimate the conditional mean outcome curves under each treatment arm using the revised model without race and gender. This shows how treatment effects vary with risk when demographic predictors are excluded.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate treatment effect using splines</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>fit_out <span class="ot">&lt;-</span> <span class="fu">estimate_spline</span>(sim_out, <span class="at">family=</span><span class="fu">binomial</span>())</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_spline_curves</span>(fit_out, sim_out, pce_predict, cvd_prob, cohort_df,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_lab  =</span> <span class="st">"Probability of cardiovascular event"</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"No Medication"</span>, <span class="st">"Medication"</span>),</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_path =</span> <span class="st">"figures/case5_spline_curves.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="adaptive_rd_demo_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Lastly, we compute the local ATE at the updated threshold to assess how removing race and gender affects the estimated treatment effect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -- ATE at last risk threshold</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_ate_at_threshold</span>(fit_out, sim_out, cohort_df, pce_predict, cvd_prob)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Metric</th>
<th style="text-align: center;">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Estimated ATE</td>
<td style="text-align: center;">0.128</td>
</tr>
<tr class="even">
<td style="text-align: left;">95% CI</td>
<td style="text-align: center;">[0.034, 0.221]</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Truth</td>
<td style="text-align: center;">0.090</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bias</td>
<td style="text-align: center;">0.038</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Coverage</td>
<td style="text-align: center;">Yes</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="save-panels" class="level2">
<h2 class="anchored" data-anchor-id="save-panels">Save panels</h2>
<p>We combine individual scenario figures into multi-panel layouts to create concise visual summaries. The first panel assembles threshold-adaptation scenarios, while the second highlights model-adaptation scenarios. These panels are saved as high-resolution files for inclusion in the manuscript.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Figure for threshold adaptation</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>fig_files <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"figures/case1_threshold_trajectory.rds"</span>,  <span class="co"># upper left</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"figures/case3_cohen_d_to_nnt.rds"</span>,        <span class="co"># lower left</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"figures/case1_spline_curves.rds"</span>,         <span class="co"># upper middle</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"figures/case3_risk_to_cohen_d.rds"</span>,       <span class="co"># lower middle</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"figures/case2_spline_curves.rds"</span>,         <span class="co"># upper right</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"figures/case3_spline_curves.rds"</span>          <span class="co"># lower right</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">FALSE</span>)  <span class="co"># &lt;-- KEY CHANGE</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Build and save the panel as EPS</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="fu">save_panel_from_rds</span>(fig_files, <span class="at">filename =</span> <span class="st">"figures/fig_threshold_adaptation.pdf"</span>, <span class="at">width =</span> <span class="dv">16</span>, <span class="at">height =</span> <span class="dv">10</span>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Figure for model adaptation</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>fig_files <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"figures/case4_risk_transform.rds"</span>,  <span class="co"># row 1</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"figures/case4_risk_trajectory.rds"</span>,  <span class="co"># row 2</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"figures/case4_spline_curves.rds"</span>,   <span class="co"># row 3</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"figures/case5_spline_curves.rds"</span>  <span class="co"># row 4</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>), <span class="at">nrow =</span> <span class="dv">4</span>, <span class="at">byrow =</span> <span class="cn">FALSE</span>)  <span class="co"># &lt;-- KEY CHANGE</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Build and save the panel as EPS</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="fu">save_panel_from_rds</span>(fig_files, <span class="at">filename =</span> <span class="st">"figures/fig_model_adaptation.pdf"</span>, <span class="at">width =</span> <span class="dv">9</span>, <span class="at">height =</span> <span class="dv">18</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>