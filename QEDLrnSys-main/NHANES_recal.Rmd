---
title: "NHANES diabetes"
author: "Valerie Odeh"
date: "12/15/2022"
output: html_document
---

```{r setup, include=FALSE}
library(foreign)
library(tidyverse)
library(mice)
library(dplyr)
library(rdlocrand)
library(gee)
```

# NHANES DATA 2017-2018
```{r}
#set working directory
file=setwd("/Users/valerieodeh/Documents/Research/HealthSystems/NHANES2017-2018")

getwd()

demo <- read.xport(file="DEMO_J.XPT")
bpx <- read.xport(file="BPX_J.XPT")
diq <- read.xport(file="DIQ_J.XPT")
bpq <- read.xport(file="BPQ_J.XPT")
hdl <- read.xport(file="HDL_J.XPT")
trigly <- read.xport(file="TRIGLY_J.XPT")
bmx <- read.xport(file="BMX_J.XPT")
glu <- read.xport(file="GLU_J.XPT")
```


```{r}
#put all data frames into list
df_list <- list(demo, bpx, diq, bpq, hdl, trigly, bmx, glu)      

#merge all data frames together
NHANES <- df_list %>% reduce(full_join, by='SEQN')
#NHANES <- df_list %>% reduce(merge, by='SEQN', all=FALSE)
```

```{r}
data <- NHANES[,c("RIDAGEYR", "RIAGENDR", "BPXSY1", "BPXDI1","BPQ050A", "LBXGLU", "LBDHDD", "LBXTR", "BMXBMI", "DIQ010", "DIQ175A")]

data <- subset(data, RIDAGEYR>=45 & RIDAGEYR<=65) #between 45 and 65 years old (middle aged)
data <- subset(data, DIQ010=="2") #no diab initially
```

```{r}
#data cleaning 

#gender #1=male(ref), 2=female ---> change to 1=male(ref), 0=female
data$RIAGENDR <- ifelse(data$RIAGENDR=="1",1,0)

#BP meds #1=yes(ref), 2=no ---> change to 1=yes(ref), 0=no
data$BPQ050A <- ifelse(data$BPQ050A=="1",1,0)

#diabetes family history #10=yes(ref) ---> change to 1=yes(ref), 0=no
data$DIQ175A<- ifelse(data$DIQ175A=="10",1,0)
data$DIQ175A[is.na(data$DIQ175A)] <- 0
str(data)
```

```{r}
#data imputation
set.seed(1)
imputed <- mice(data)
data <- complete(imputed)
```

# 7-year risk of diabetes type 2

```{r}
#for risk calc:

#age categories
data$age1 <- ifelse(data$RIDAGEYR < 50, 1, 0)
data$age2 <- ifelse(data$RIDAGEYR >= 50 & data$RIDAGEYR < 65, 1, 0)
data$age3 <- ifelse(data$RIDAGEYR >= 65, 1, 0)
#BMI categories
data$BMI1 <- ifelse(data$BMXBMI < 25, 1, 0)
data$BMI2 <- ifelse(data$BMXBMI >= 25 & data$BMXBMI < 30, 1, 0)
data$BMI3 <- ifelse(data$BMXBMI >= 30, 1, 0)
#HDL categories
data$HDL <- ifelse((data$RIAGENDR == 1 & data$LBDHDD < 40) | (data$RIAGENDR == 0 & data$LBDHDD < 50), 1, 0)
#triglyceride
data$trig <- ifelse(data$LBXTR >= 150, 1, 0)
#fasting glucose
data$glucose <- ifelse(data$LBXGLU >= 100, 1, 0)
#blood pressure
data$bp <- ifelse(data$BPXSY1 >= 130 | data$BPXDI1 >=85 | data$BPQ050A == 1, 1, 0)
```


```{r}
#cutoff selection
data$id <- seq(1, nrow(data))
c <- .3 #fixed cutoff


#risk score
data$Zhat <- -5.517-0.018*data$age2-0.081*data$age3-0.010*data$RIAGENDR+0.565*data$DIQ175A+0.301*data$BMI2+0.92*data$BMI3+0.498*data$bp+0.944*data$HDL+0.575*data$trig+1.980*data$glucose

data$risk <- (1/(1+exp(-data$Zhat)))-c

#treatment assignment 
data$A <- ifelse(data$risk>=0, 1, 0)
table(data$A)
```

#Scenario: Model updating - recalibrated regression coefficients with or without shrinkage
s=0 (static risk prediction model)
s=1 (recalibrated regression coefficient)
s=i/n (person specific shrinkage increasing as more patients come in)
```{r}
data2 <- data # for case 1: adjustment of intercept and slope method 2 Janssen et al.
```

```{r}
#create synthetic diabetes output in 6 years (did the patient end up getting diab or not)

#data$Zprob <- 1/(1+exp(-3.267-0.02*data$age2-0.0876*data$age3-0.027*data$RIAGENDR+0.787*data$DIQ175A+0.72*data$BMI2+1.2*data$BMI3+0.5*data$bp+1.7*data$HDL+1.93*data$trig+3.123*data$glucose))

data$Zprob <- 1/(1+exp(-0.5*data$Zhat-0.5))
               
set.seed(1)
data$Zreal <- rbinom(n=nrow(data), size = 1, prob = data$Zprob) 
table(data$Zreal)
```

#Scenario not incorporating A in the update
Start with first 100 samples and recalibrate for every sample after that:
```{r}
data$a <- 0
data$b <- 0
data$Zhatup <- data$Zhat
data$riskup <- data$risk



#fit a log reg and update linear predictor
for(i in 100:(nrow(data)-1)) {
calibrate <- glm(Zreal~Zhatup, family = "binomial", data = data[1:i,])
data$a[i+1] <- calibrate$coefficients[[1]]
data$b[i+1] <- calibrate$coefficients[[2]]
data$Zhatup[i+1] <- data$a[i+1]+data$b[i+1]*data$Zhat[i+1]
data$riskup[i+1] <- 1/(1+exp(-data$Zhatup[i+1]))

}
```

```{r}
plot(data$a)
plot(data$b)

```


#Incorporate intervention in the update (data2)
```{r}
#create synthetic diabetes output in 6 years (did the patient end up getting diab or not)

data2$Zprob <- ifelse(data2$A == 1, 1/(1+exp(-(0.5*data2$Zhat+0.5-2))), 1/(1+exp(-(0.5*data2$Zhat+0.5))))
               
set.seed(1)
data2$Zreal <- rbinom(n=nrow(data2), size = 1, prob = data2$Zprob)
table(data2$Zreal)
```


s=0 (static risk prediction model)
s=1 (recalibrated regression coefficient)
Start with first 200 samples and recalibrate for every sample after that:
```{r}
set.seed(1)
data2$a <- 0
data2$b <- 0

data2$s <- 1 #recalibrated regression coefficients
#data2$s <- 0 #static risk pred model
#data2$s <- data2$id/nrow(data2) #varying shrinkage

data2$Zhatup <- data2$Zhat
data2$riskup <- data2$risk
data2$Aup <- data2$A
data2$Zprobup <- data2$Zprob
data2$Zrealup <- data2$Zreal


#fit a log reg and update linear predictor
for(i in 200:(nrow(data2)-1)) {
calibrate <- glm(Zrealup~Zhatup+Aup, family = "binomial", data = data2[1:i,])
data2$a[i+1] <- calibrate$coefficients[[1]]
data2$b[i+1] <- calibrate$coefficients[[2]]
data2$Zhatup[i+1] <- data2$s[i+1]*data2$a[i+1]+(1+data2$s[i+1]*(data2$b[i+1]-1))*data2$Zhat[i+1]
data2$riskup[i+1] <- (1/(1+exp(-data2$Zhatup[i+1])))-c
data2$Aup[i+1] <- ifelse(data2$riskup[i+1]>=0, 1, 0)
data2$Zprobup[i+1] <- ifelse(data2$Aup[i+1] == 1, 1/(1+exp(-(0.5*data2$Zhatup[i+1]+0.5-2))), 1/(1+exp(-(0.5*data2$Zhatup[i+1]+0.5))))
data2$Zrealup[i+1] <- rbinom(n=1, size = 1, prob = data2$Zprobup[i+1])
}
```


```{r}
table(data2$Zreal)
table(data2$Zrealup)
table(data2$Zreal[1:100])
```

```{r}
table(data2$A)
table(data2$Aup)
table(data2$A[1:100])
```

#Varying cutoff at a target

s=0 (static risk prediction model)
s=1 (recalibrated regression coefficient)
Start with first 200 samples and recalibrate for every sample after that:
```{r}
set.seed(1)
data2$a <- 0
data2$b <- 0

data2$s <- 1 #recalibrated regression coefficients
#data2$s <- 0 #static risk pred model
#data2$s <- data2$id/nrow(data2) #varying shrinkage

data2$Zhatup <- data2$Zhat
data2$riskup <- data2$risk
data2$Aup <- data2$A
data2$Zprobup <- data2$Zprob
data2$Zrealup <- data2$Zreal


#fit a log reg and update linear predictor
for(i in 200:(nrow(data2)-1)) {
calibrate <- glm(Zrealup~Zhatup+Aup, family = "binomial", data = data2[1:i,])
data2$a[i+1] <- calibrate$coefficients[[1]]
data2$b[i+1] <- calibrate$coefficients[[2]]
data2$Zhatup[i+1] <- data2$s[i+1]*data2$a[i+1]+(1+data2$s[i+1]*(data2$b[i+1]-1))*data2$Zhat[i+1]
data2$riskup[i+1] <- (1/(1+exp(-data2$Zhatup[i+1])))-c
data2$Aup[i+1] <- ifelse(data2$riskup[i+1]>=0, 1, 0)
data2$Zprobup[i+1] <- ifelse(data2$Aup[i+1] == 1, 1/(1+exp(-(0.5*data2$Zhatup[i+1]+0.5-2))), 1/(1+exp(-(0.5*data2$Zhatup[i+1]+0.5))))
data2$Zrealup[i+1] <- rbinom(n=1, size = 1, prob = data2$Zprobup[i+1])
}
```
























```{r}
d <- density(data2$riskup)
plot(d)
abline(v=c(.3), col="red", lwd=1)
```


```{r}
library(rddensity)

summary(rddensity(data2$riskup, c = .3, bino = FALSE, massPoints=FALSE))

```



```{r}
d <- density(data2$risk)
plot(d)
abline(v=c(.3), col="red", lwd=1)
```

```{r}
library(rddensity)

summary(rddensity(data2$risk, c = .3, bino = FALSE, massPoints=FALSE))

```






```{r}
plot(data2$riskup,data2$Zrealup)

agg_tbl <- data2 %>% group_by(Aup) %>% 
  summarise(mean_outcome=mean(Zrealup))
```


# Evaluate all patients with the recalibration of the last patient (data 2)

```{r}
datalast2 <- data.frame(data2[,"Zhat"])
colnames(datalast2) <- "Zhat"
```

```{r}
data2[nrow(data2),"a"]
data2[nrow(data2),"b"]

#when decreasing risk cutoff to be .15, recalibration (a and b) seems to be decreasing performance and no one has diabetes
```


```{r}
datalast2$Zhatup <- data2[nrow(data2),"a"]+data2[nrow(data2),"b"]*datalast2$Zhat
datalast2$risk <- 1/(1+exp(-datalast2$Zhatup))

#treatment assignment

datalast2$A <- ifelse(datalast2$risk>=data2[nrow(data2),"c"], 1, 0)

datalast2$Zprob <- ifelse(datalast2$A == 1, 1/(1+exp(-(0.5*datalast2$Zhatup+0.5-2))), 1/(1+exp(-(0.5*datalast2$Zhatup+0.5))))


for(i in 1:(nrow(datalast2))) {
set.seed(1)
datalast2$Zreal[i] <- rbinom(n=1, size = 1, prob = datalast2$Zprob[i])
}

table(datalast2$Zreal)
```




```{r}
d <- density(datalast2$risk)
plot(d)
abline(v=c(.3), col="red", lwd=1)
```


```{r}
library(rddensity)

summary(rddensity(datalast2$risk, c = .3, bino = FALSE, massPoints=FALSE))

```


```{r}
plot(datalast2$risk, datalast2$A)
plot(datalast2$Zreal, datalast2$A)

```

