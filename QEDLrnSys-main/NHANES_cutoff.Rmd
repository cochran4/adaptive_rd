---
title: "NHANES diabetes"
author: "Valerie Odeh"
date: "12/15/2022"
output: html_document
---

```{r setup, include=FALSE}
library(foreign)
library(tidyverse)
library(mice)
library(dplyr)
library(rdlocrand)
library(gee)
```

# NHANES DATA 2017-2018
```{r}
#set working directory
file=setwd("/Users/valerieodeh/Documents/Research/HealthSystems/NHANES2017-2018")

getwd()

demo <- read.xport(file="DEMO_J.XPT")
bpx <- read.xport(file="BPX_J.XPT")
diq <- read.xport(file="DIQ_J.XPT")
bpq <- read.xport(file="BPQ_J.XPT")
hdl <- read.xport(file="HDL_J.XPT")
trigly <- read.xport(file="TRIGLY_J.XPT")
bmx <- read.xport(file="BMX_J.XPT")
glu <- read.xport(file="GLU_J.XPT")
```


```{r}
#put all data frames into list
df_list <- list(demo, bpx, diq, bpq, hdl, trigly, bmx, glu)      

#merge all data frames together
NHANES <- df_list %>% reduce(full_join, by='SEQN')
#NHANES <- df_list %>% reduce(merge, by='SEQN', all=FALSE)
```

```{r}
data <- NHANES[,c("RIDAGEYR", "RIAGENDR", "BPXSY1", "BPXDI1","BPQ050A", "LBXGLU", "LBDHDD", "LBXTR", "BMXBMI", "DIQ010", "DIQ175A")]

data <- subset(data, RIDAGEYR>=45 & RIDAGEYR<=65) #between 45 and 65 years old (middle aged)
data <- subset(data, DIQ010=="2") #no diab initially
```

```{r}
#data cleaning 

#gender #1=male(ref), 2=female ---> change to 1=male(ref), 0=female
data$RIAGENDR <- ifelse(data$RIAGENDR=="1",1,0)

#BP meds #1=yes(ref), 2=no ---> change to 1=yes(ref), 0=no
data$BPQ050A <- ifelse(data$BPQ050A=="1",1,0)

#diabetes family history #10=yes(ref) ---> change to 1=yes(ref), 0=no
data$DIQ175A<- ifelse(data$DIQ175A=="10",1,0)
data$DIQ175A[is.na(data$DIQ175A)] <- 0
str(data)
```

```{r}
#data imputation
set.seed(1)
imputed <- mice(data)
data <- complete(imputed)
```

# 7-year risk of diabetes type 2

```{r}
#for risk calc:

#age categories
data$age1 <- ifelse(data$RIDAGEYR < 50, 1, 0)
data$age2 <- ifelse(data$RIDAGEYR >= 50 & data$RIDAGEYR < 65, 1, 0)
data$age3 <- ifelse(data$RIDAGEYR >= 65, 1, 0)
data$age <- ifelse(data$age1 == 1, 1, ifelse(data$age2 == 1, 2, 3)) #general cat for revision
data$age <- as.factor(data$age) #make age cat
#BMI categories
data$BMI1 <- ifelse(data$BMXBMI < 25, 1, 0)
data$BMI2 <- ifelse(data$BMXBMI >= 25 & data$BMXBMI < 30, 1, 0)
data$BMI3 <- ifelse(data$BMXBMI >= 30, 1, 0)
data$BMI <- ifelse(data$BMI1 == 1, 1, ifelse(data$BMI2 == 1, 2, 3)) #general cat for revision
data$BMI <- as.factor(data$BMI) #make BMI cat
#HDL categories
data$HDL <- ifelse((data$RIAGENDR == 1 & data$LBDHDD < 40) | (data$RIAGENDR == 0 & data$LBDHDD < 50), 1, 0)
#triglyceride
data$trig <- ifelse(data$LBXTR >= 150, 1, 0)
#fasting glucose
data$glucose <- ifelse(data$LBXGLU >= 100, 1, 0)
#blood pressure
data$bp <- ifelse(data$BPXSY1 >= 130 | data$BPXDI1 >=85 | data$BPQ050A == 1, 1, 0)
```


#gradient search
```{r}
data$id <- seq(1, nrow(data))

data$Zhat <- -5.517-0.018*data$age2-0.081*data$age3-0.010*data$RIAGENDR+0.565*data$DIQ175A+0.301*data$BMI2+0.92*data$BMI3+0.498*data$bp+0.944*data$HDL+0.575*data$trig+1.980*data$glucose

data$risk <- 1/(1+exp(-data$Zhat))

#initialize
c <- .3
p <- .5
data$c <- .3
data$A <- ifelse(data$risk>=data$c, 1, 0)


data$Zprob <- ifelse(data$A == 1, 1/(1+exp(-(0.5*data$Zhat+0.5-2))), 1/(1+exp(-(0.5*data$Zhat+0.5))))
               
set.seed(1)
data$Zreal <- rbinom(n=nrow(data), size = 1, prob = data$Zprob)
table(data$Zreal)
```

#only varying cutoff (no recal or revision)
```{r}
set.seed(1)
for(i in 2:nrow(data)) {

data$c[i] <- ifelse(sum(data$A[1:i-1])/data$id[i-1]<p, max(data$c[i-1]-0.001,0), ifelse(sum(data$A[1:i-1])/data$id[i-1]>p, min(data$c[i-1]+0.001,c), data$c[i-1]))
data$A[i] <- ifelse(data$risk[i]>=data$c[i], 1, 0)
data$Zprob[i] <- ifelse(data$A[i] == 1, 1/(1+exp(-(0.5*data$Zhat[i]+0.5-2))), 1/(1+exp(-(0.5*data$Zhat[i]+0.5))))
data$Zreal[i] <- rbinom(n=1, size = 1, prob = data$Zprob[i])
  
}
```

```{r}
table(data$Zreal)
sum(data$A)/nrow(data)
```

```{r}
plot(data$c)
```

#same code but with normalized risk R=R-c
```{r}
#initialize
c <- 1
p <- .5
data$c <- .3
data$id <- seq(1, nrow(data))

data$Zhat <- -5.517-0.018*data$age2-0.081*data$age3-0.010*data$RIAGENDR+0.565*data$DIQ175A+0.301*data$BMI2+0.92*data$BMI3+0.498*data$bp+0.944*data$HDL+0.575*data$trig+1.980*data$glucose

data$risk <- (1/(1+exp(-data$Zhat)))-data$c


data$A <- ifelse(data$risk>=0, 1, 0)


data$Zprob <- ifelse(data$A == 1, 1/(1+exp(-(0.5*data$Zhat+0.5-2))), 1/(1+exp(-(0.5*data$Zhat+0.5))))
               
set.seed(1)
data$Zreal <- rbinom(n=nrow(data), size = 1, prob = data$Zprob)
table(data$Zreal)
```


```{r}
set.seed(1)
for(i in 2:nrow(data)) {

data$c[i] <- ifelse(sum(data$A[1:i-1])/data$id[i-1]<p, max(data$c[i-1]-0.01,0), ifelse(sum(data$A[1:i-1])/data$id[i-1]>p, min(data$c[i-1]+0.01,c), data$c[i-1]))
data$risk[i] <- (1/(1+exp(-data$Zhat[i])))-data$c[i]
data$A[i] <- ifelse(data$risk[i]>=0, 1, 0)
data$Zprob[i] <- ifelse(data$A[i] == 1, 1/(1+exp(-(0.5*data$Zhat[i]+0.5-2))), 1/(1+exp(-(0.5*data$Zhat[i]+0.5))))
data$Zreal[i] <- rbinom(n=1, size = 1, prob = data$Zprob[i])
  
}
```

```{r}
table(data$Zreal)
sum(data$A)/nrow(data)
```


#line search

```{r}
data$id <- seq(1, nrow(data))

data$Zhat <- -5.517-0.018*data$age2-0.081*data$age3-0.010*data$RIAGENDR+0.565*data$DIQ175A+0.301*data$BMI2+0.92*data$BMI3+0.498*data$bp+0.944*data$HDL+0.575*data$trig+1.980*data$glucose

data$risk <- 1/(1+exp(-data$Zhat))

#initialize
#c <- .3
p <- .5
data$c <- .3
data$A <- ifelse(data$risk>=data$c, 1, 0)


data$Zprob <- ifelse(data$A == 1, 1/(1+exp(-(0.5*data$Zhat+0.5-2))), 1/(1+exp(-(0.5*data$Zhat+0.5))))
               
set.seed(1)
data$Zreal <- rbinom(n=nrow(data), size = 1, prob = data$Zprob)
table(data$Zreal)
```


```{r}

```



















#varying both cutoff by prob of assignment and recalibration
Note: I can use this code for both none recalibrated or recalibrated results
```{r}
data2 <- data
```

s=0 (static risk prediction model)
s=1 (recalibrated regression coefficient)
Start with first 200 samples and recalibrate for every sample after that:
```{r}
set.seed(1)
data2$a <- 0
data2$b <- 0

data2$s <- 1 #recalibrated regression coefficients
#data2$s <- 0 #static risk pred model
#data2$s <- data2$id/nrow(data2) #varying shrinkage

data2$Zhatup <- data2$Zhat
data2$riskup <- data2$risk
data2$cup <- data2$c
data2$Aup <- data2$A
data2$Zprobup <- data2$Zprob
data2$Zrealup <- data2$Zreal


#fit a log reg and update linear predictor
for(i in 200:(nrow(data2)-1)) {
calibrate <- glm(Zrealup~Zhatup+Aup, family = "binomial", data = data2[1:i,])
data2$a[i+1] <- calibrate$coefficients[[1]]
data2$b[i+1] <- calibrate$coefficients[[2]]
data2$Zhatup[i+1] <- data2$s[i+1]*data2$a[i+1]+(1+data2$s[i+1]*(data2$b[i+1]-1))*data2$Zhat[i+1]
data2$riskup[i+1] <- 1/(1+exp(-data2$Zhatup[i+1]))
data2$cup[i+1] <- ifelse(sum(data2$Aup[1:i])/data2$id[i]<p, max(data2$cup[i]-0.01,0), ifelse(sum(data2$Aup[1:i])/data2$id[i]>p, min(data2$cup[i]+0.01,c), data2$cup[i]))
data2$Aup[i+1] <- ifelse(data2$riskup[i+1]>=data2$cup[i+1], 1, 0)
data2$Zprobup[i+1] <- ifelse(data2$Aup[i+1] == 1, 1/(1+exp(-(0.5*data2$Zhatup[i+1]+0.5-2))), 1/(1+exp(-(0.5*data2$Zhatup[i+1]+0.5))))
data2$Zrealup[i+1] <- rbinom(n=1, size = 1, prob = data2$Zprobup[i+1])
}
```

Non recalibrated results:
```{r}
table(data2$Zreal)
sum(data2$A)/nrow(data2)
```

Recalibrated results:
```{r}
table(data2$Zrealup)
sum(data2$Aup)/nrow(data2)
```

#varying both cutoff by prob of assignment and revision
```{r}
data3 <- data
```


```{r}
set.seed(1)

#initialize for revise stage
data3$s <- 1 #revised regression coefficients
#data3$s <- 0 #original regression coefficients
#data3$s <- data3$id/nrow(data3) #varying shrinkage

data3$int_betarev <- 0
data3$age2_betarev <- 0
data3$age3_betarev <- 0
data3$RIAGENDR_betarev <- 0
data3$DIQ175A_betarev <- 0
data3$BMI2_betarev <- 0
data3$BMI3_betarev <- 0
data3$bp_betarev <- 0
data3$HDL_betarev <- 0
data3$trig_betarev <- 0
data3$glucose_betarev <- 0
data3$Zhatup <- data3$Zhat
data3$riskup <- data3$risk
data3$cup <- data3$c
data3$Aup <- data3$A
data3$Zprobup <- data3$Zprob
data3$Zrealup <- data3$Zreal



#fit a log reg and update linear predictor
for(i in 200:(nrow(data3)-1)) {

  #revise (fit a new regression model)
revise <- glm(Zrealup~age+RIAGENDR+DIQ175A+BMI+bp+HDL+trig+glucose+Aup, family = "binomial", data=data3[1:i,])

  #new models betas after shrinkage
#data3$Zhatrev[i+1] <- predict(revise, newdata=data3[i+1,])
data3$int_betarev[i+1] <- (-5.517)+data3$s[i+1]*(revise$coefficients[[1]]-(-5.517))
data3$age2_betarev[i+1] <- (-0.018)+data3$s[i+1]*(revise$coefficients[[2]]-(-0.018))
data3$age3_betarev[i+1] <- (-0.081)+data3$s[i+1]*(revise$coefficients[[3]]-(-0.081))
data3$RIAGENDR_betarev[i+1] <- (-0.010)+data3$s[i+1]*(revise$coefficients[[4]]-(-0.010))
data3$DIQ175A_betarev[i+1] <- (0.565)+data3$s[i+1]*(revise$coefficients[[5]]-(0.565))
data3$BMI2_betarev[i+1] <- (0.301)+data3$s[i+1]*(revise$coefficients[[6]]-(0.301))
data3$BMI3_betarev[i+1] <- (0.92)+data3$s[i+1]*(revise$coefficients[[7]]-(0.92))
data3$bp_betarev[i+1] <- (0.498)+data3$s[i+1]*(revise$coefficients[[8]]-(0.498))
data3$HDL_betarev[i+1] <- (0.944)+data3$s[i+1]*(revise$coefficients[[9]]-(0.944))
data3$trig_betarev[i+1] <- (0.575)+data3$s[i+1]*(revise$coefficients[[10]]-(0.575))
data3$glucose_betarev[i+1] <- (1.980)+data3$s[i+1]*(revise$coefficients[[11]]-(1.980))

data3$Zhatup[i+1] <- data3$int_betarev[i+1]+data3$age2_betarev[i+1]*data3$age2[i+1]+data3$age3_betarev[i+1]*data3$age3[i+1]+data3$RIAGENDR_betarev[i+1]*data3$RIAGENDR[i+1]+data3$DIQ175A_betarev[i+1]*data3$DIQ175A[i+1]+data3$BMI2_betarev[i+1]*data3$BMI2[i+1]+data3$BMI3_betarev[i+1]*data3$BMI3[i+1]+data3$bp_betarev[i+1]*data3$bp[i+1]+data3$HDL_betarev[i+1]*data3$HDL[i+1]+data3$trig_betarev[i+1]*data3$trig[i+1]+data3$glucose_betarev[i+1]*data3$glucose[i+1] 

data3$riskup[i+1] <- 1/(1+exp(-data3$Zhatup[i+1]))
data3$cup[i+1] <- ifelse(sum(data3$Aup[1:i])/data3$id[i]<p, max(data3$cup[i]-0.01,0), ifelse(sum(data3$Aup[1:i])/data3$id[i]>p, min(data3$cup[i]+0.01,c), data3$cup[i]))
data3$Aup[i+1] <- ifelse(data3$riskup[i+1]>=data3$cup[i+1], 1, 0)
data3$Zprobup[i+1] <- ifelse(data3$Aup[i+1] == 1, 1/(1+exp(-(0.5*data3$Zhatup[i+1]+0.5-2))), 1/(1+exp(-(0.5*data3$Zhatup[i+1]+0.5))))
data3$Zrealup[i+1] <- rbinom(n=1, size = 1, prob = data3$Zprobup[i+1])

}

```

Recalibrated results: revised model tend to have more treated individuals may want to increased cutoff score in this scenario (or increase max cap in cutoff update)
```{r}
table(data3$Zrealup)
table(data3$Aup)
sum(data3$Aup)/nrow(data3)
```
